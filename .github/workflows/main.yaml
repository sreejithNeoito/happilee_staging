name: Deploy to EC2
on:
  push:
    branches: [main]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          script: |
            echo "ğŸš€ Starting deployment to production server..."
            echo "â° Deployment started at: $(date)"

            echo "ğŸ“‚ Navigating to project directory..."
            cd /var/www/happilee_staging
            echo "âœ… Current directory: $(pwd)"

            echo "ğŸ”§ Setting up git authentication..."
            sudo -u www-data git remote set-url origin https://${{ secrets.GIT_USERNAME }}:${{ secrets.GIT_TOKEN }}@github.com/sreejithNeoito/happilee_staging.git && sudo -u www-data git stash save
            echo "âœ… Git authentication configured"

            echo "ğŸ“¥ Pulling latest changes from main branch..."
            if sudo -u www-data git pull origin main; then
              echo "âœ… Git pull completed successfully"
            else
              echo "âŒ Git pull failed!"
              exit 1
            fi

            echo "ğŸ§¹ Cleaning up git authentication..."
            sudo -u www-data git remote set-url origin https://github.com/sreejithNeoito/happilee_staging.git
            echo "âœ… Git authentication cleaned up"

            echo "ğŸ”’ Setting file permissions..."
            sudo chmod -R 755 .
            sudo chmod -R 775 wp-content/uploads/ 2>/dev/null || true
            echo "âœ… File permissions updated"

            echo "ğŸ”„ Restarting services..."
            if sudo systemctl reload nginx; then
              echo "âœ… Nginx reloaded successfully"
            else
              echo "âŒ Nginx reload failed!"
            fi

            if sudo systemctl restart php8.1-fpm; then
              echo "âœ… PHP-FPM restarted successfully"
            else
              echo "âŒ PHP-FPM restart failed!"
            fi

            echo "ğŸ‰ Deployment completed successfully!"
            echo "â° Deployment finished at: $(date)"
